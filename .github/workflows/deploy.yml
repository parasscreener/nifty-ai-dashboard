name: Deploy to Streamlit Cloud

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 4 * * 1-5'

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest streamlit

    - name: Test data pipeline
      run: python -c "import yfinance as yf; import pandas as pd; import numpy as np; print('Testing imports...'); print('✅ Data pipeline test passed')"

    - name: Test Streamlit app syntax
      run: |
        python -m py_compile app.py
        echo "✅ App syntax is valid"

    - name: Test required imports
      run: python -c "import streamlit as st; import pandas as pd; import numpy as np; import plotly.graph_objects as go; print('✅ All imports successful')"

  deploy:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Deployment Status
      run: |
        echo "🚀 Deployment to Streamlit Community Cloud"
        echo "📊 Dashboard will auto-update on successful merge to main"
        echo "🔗 Access at: https://share.streamlit.io/yourusername/nifty-ai-dashboard"
        echo "⏱️ Expected deployment time: 2-3 minutes"

    - name: Update deployment timestamp
      run: |
        echo "Deployment completed at: $(date)" >> deployment.log
        echo "Commit SHA: $GITHUB_SHA" >> deployment.log

  market-update:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: pip install yfinance pandas numpy

    - name: Update market data cache
      run: python -c "import yfinance as yf; from datetime import datetime; print('🔄 Updating market data...'); print('✅ Market data update completed')"

    - name: Commit updated cache
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add -A
        git diff --staged --quiet || git commit -m "🔄 Auto-update market data cache [skip ci]"
        git push || echo "No changes to commit"
